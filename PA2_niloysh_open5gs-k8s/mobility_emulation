##############
# 08/01/2026 #
##############
t√≥m t·∫Øt: k·ªãch b·∫£n tr∆∞·ªõc l√† t·∫Øt gNB1 v√† deploy l·∫°i UE ƒë·ªÉ nh·∫≠n gNB2
Thay ƒë·ªïi th√†nh: T·∫Øt gNB1 v√† ƒë·ªÉ t·ª± UE chuy·ªÉn gNB2
###
root@MasterK8s:~# NS=open5gs
root@MasterK8s:~#
root@MasterK8s:~#
root@MasterK8s:~# Ki·ªÉm tra  2 gNB^C
root@MasterK8s:~# kubectl scale deploy/ueransim-gnb-mec1 --replicas=1 -n $NS
kubectl scale deploy/ueransim-gnb-mec2 --replicas=1 -n $NS
kubectl get pods -n $NS -o wide | grep ueransim-gnb
deployment.apps/ueransim-gnb-mec1 scaled
deployment.apps/ueransim-gnb-mec2 scaled
ueransim-gnb-mec1-5b48c8f7f7-dwsqp   1/1     Running   0          6m16s   192.168.43.208    open5gs     <none>
ueransim-gnb-mec2-57f6776545-rftts   1/1     Running   0          6m16s   192.168.30.170    workerk8s   <none>
root@MasterK8s:~#
root@MasterK8s:~# kubectl rollout restart deploy/ueransim-ue1 -n $NS
kubectl get pods -n $NS -o wide | grep ueransim-ue1
deployment.apps/ueransim-ue1 restarted
ueransim-ue1-8688bf4dc7-pnlk6        0/1     Init:0/1   0          0s      <none>            ue          <none>
ueransim-ue1-b644fb4d7-gh4x7         1/1     Running    0          23m     192.168.131.204   ue          <none>
root@MasterK8s:~# kubectl get pods -n $NS -o wide | grep ueransim-ue1
ueransim-ue1-8688bf4dc7-pnlk6        1/1     Running       0          15s     192.168.131.205   ue          <non
ueransim-ue1-b644fb4d7-gh4x7         1/1     Terminating   0          23m     192.168.131.204   ue          <non
root@MasterK8s:~# T·∫°o UE^C
root@MasterK8s:~#
root@MasterK8s:~#
root@MasterK8s:~# kubectl get pods -n $NS -o wide | grep ueransim-ue1
ueransim-ue1-8688bf4dc7-pnlk6        1/1     Running       0          36s     192.168.131.205   ue          <non
ueransim-ue1-b644fb4d7-gh4x7         1/1     Terminating   0          23m     192.168.131.204   ue          <non
root@MasterK8s:~# UEPOD=$(kubectl get pods -o name -n $NS | grep ueransim-ue1 | head -n1)
echo $UEPOD
pod/ueransim-ue1-8688bf4dc7-pnlk6
root@MasterK8s:~# kubectl get pods -n $NS -o wide | grep ueransim-ue1
ueransim-ue1-8688bf4dc7-pnlk6        1/1     Running   0          2m9s    192.168.131.205   ue          <none>
root@MasterK8s:~# Ti·∫øn h√†nh t·∫Øt gnb mec1^C
root@MasterK8s:~#
root@MasterK8s:~#
root@MasterK8s:~# kubectl scale deploy/ueransim-gnb-mec1 --replicas=0 -n $NS
deployment.apps/ueransim-gnb-mec1 scaled
root@MasterK8s:~# kubectl get pods -n $NS -o wide | grep ueransim-gnb
ueransim-gnb-mec1-5b48c8f7f7-dwsqp   1/1     Terminating   0          16m     192.168.43.208    open5gs     <none>           <none>
ueransim-gnb-mec2-57f6776545-rftts   1/1     Running       0          16m     192.168.30.170    workerk8s   <none>           <none>
root@MasterK8s:~# kubectl get pods -n $NS -o wide | grep ueransim-gnb
ueransim-gnb-mec2-57f6776545-rftts   1/1     Running   0          18m     192.168.30.170    workerk8s   <none>           <none>
root@MasterK8s:~#


root@MasterK8s:~# tab n√†y xem log UE^C
root@MasterK8s:~# kubectl logs $UEPOD -n $NS -c ue --follow
error: error from server (NotFound): pods "ueransim-ue1-b644fb4d7-gh4x7" not found in namespace "open5gs"
root@MasterK8s:~# UEPOD=$(kubectl get pods -o name -n $NS | grep ueransim-ue1 | head -n1)
echo $UEPOD
pod/ueransim-ue1-8688bf4dc7-pnlk6
root@MasterK8s:~# kubectl logs $UEPOD -n $NS -c ue --follow
UERANSIM v3.2.6
[2026-01-08 12:48:31.424] [nas] [info] UE switches to state [MM-DEREGISTERED/PLMN-SEARCH]
[2026-01-08 12:48:31.426] [rrc] [debug] New signal detected for cell[1], total [1] cells in coverage
[2026-01-08 12:48:31.426] [rrc] [debug] New signal detected for cell[2], total [2] cells in coverage
[2026-01-08 12:48:31.426] [nas] [info] Selected plmn[001/01]
[2026-01-08 12:48:31.427] [rrc] [info] Selected cell plmn[001/01] tac[1] category[SUITABLE]
[2026-01-08 12:48:31.427] [nas] [info] UE switches to state [MM-DEREGISTERED/PS]
[2026-01-08 12:48:31.427] [nas] [info] UE switches to state [MM-DEREGISTERED/NORMAL-SERVICE]
[2026-01-08 12:48:31.427] [nas] [debug] Initial registration required due to [MM-DEREG-NORMAL-SERVICE]
[2026-01-08 12:48:31.429] [nas] [debug] UAC access attempt is allowed for identity[0], category[MO_sig]
[2026-01-08 12:48:31.430] [nas] [debug] Sending Initial Registration
[2026-01-08 12:48:31.430] [nas] [info] UE switches to state [MM-REGISTER-INITIATED]
[2026-01-08 12:48:31.430] [rrc] [debug] Sending RRC Setup Request
[2026-01-08 12:48:31.431] [rrc] [info] RRC connection established
[2026-01-08 12:48:31.431] [rrc] [info] UE switches to state [RRC-CONNECTED]
[2026-01-08 12:48:31.431] [nas] [info] UE switches to state [CM-CONNECTED]
[2026-01-08 12:48:31.462] [nas] [debug] Authentication Request received
[2026-01-08 12:48:31.479] [nas] [debug] Security Mode Command received
[2026-01-08 12:48:31.479] [nas] [debug] Selected integrity[2] ciphering[0]
[2026-01-08 12:48:31.520] [nas] [debug] Registration accept received
[2026-01-08 12:48:31.520] [nas] [info] UE switches to state [MM-REGISTERED/NORMAL-SERVICE]
[2026-01-08 12:48:31.520] [nas] [debug] Sending Registration Complete
[2026-01-08 12:48:31.520] [nas] [info] Initial Registration is successful
[2026-01-08 12:48:31.520] [nas] [debug] Sending PDU Session Establishment Request
[2026-01-08 12:48:31.520] [nas] [debug] UAC access attempt is allowed for identity[0], category[MO_sig]
[2026-01-08 12:48:31.724] [nas] [debug] Configuration Update Command received
[2026-01-08 12:48:31.763] [nas] [debug] PDU Session Establishment Accept received
[2026-01-08 12:48:31.763] [nas] [info] PDU Session establishment is successful PSI[1]
[2026-01-08 12:48:31.796] [app] [info] Connection setup for PDU session[1] is successful, TUN interface[uesimtun0, 10.41.0.7] is up.
[2026-01-08 12:58:38.697] [rrc] [debug] Signal lost for cell[1], total [1] cells in coverage
[2026-01-08 12:58:38.697] [nas] [error] Radio link failure detected
[2026-01-08 12:58:38.697] [nas] [info] UE switches to state [CM-IDLE]
[2026-01-08 12:58:38.697] [nas] [info] UE switches to state [MM-REGISTERED/PS]
[2026-01-08 12:58:38.697] [nas] [info] UE switches to state [MM-REGISTERED/PLMN-SEARCH]
[2026-01-08 12:58:39.167] [rrc] [info] Selected cell plmn[001/01] tac[2] category[SUITABLE]
[2026-01-08 12:58:39.167] [nas] [info] UE switches to state [MM-REGISTERED/PS]
[2026-01-08 12:58:39.167] [nas] [info] UE switches to state [MM-REGISTERED/NORMAL-SERVICE]

01[2026-01-08 13:04:10.690] [nas] [debug] Uplink data status changed PSI[1] pending[true]
[2026-01-08 13:04:10.690] [nas] [debug] Service request required due to [IDLE-UPLINK-DATA-PENDING]
[2026-01-08 13:04:10.691] [nas] [debug] UAC access attempt is allowed for identity[0], category[MO_data]
[2026-01-08 13:04:10.691] [nas] [debug] Sending Service Request due to [IDLE-UPLINK-DATA-PENDING]
[2026-01-08 13:04:10.691] [nas] [info] UE switches to state [MM-SERVICE-REQUEST-INITIATED]
[2026-01-08 13:04:10.691] [rrc] [debug] Sending RRC Setup Request
[2026-01-08 13:04:10.693] [rrc] [info] RRC connection established
[2026-01-08 13:04:10.693] [rrc] [info] UE switches to state [RRC-CONNECTED]
[2026-01-08 13:04:10.693] [nas] [info] UE switches to state [CM-CONNECTED]
[2026-01-08 13:04:10.711] [nas] [info] Service Accept received
[2026-01-08 13:04:10.711] [nas] [info] UE switches to state [MM-REGISTERED/PS]
[2026-01-08 13:04:10.711] [nas] [info] UE switches to state [MM-REGISTERED/NORMAL-SERVICE]





echo $GNB2POD
error: flag needs an argument: 'n' in -n
See 'kubectl get --help' for usage.

root@MasterK8s:~# NS=open5gs
GNB2POD=$(kubectl get pods -n $NS -o name | grep ueransim-gnb-mec2 | head -n1)
echo $GNB2POD
pod/ueransim-gnb-mec2-57f6776545-rftts
root@MasterK8s:~# kubectl logs $GNB2POD -n $NS -c gnb --follow
UERANSIM v3.2.6
[2026-01-08 12:41:39.187] [sctp] [info] Trying to establish SCTP connection... (10.10.3.200:38412)
[2026-01-08 12:41:39.194] [sctp] [info] SCTP connection established (10.10.3.200:38412)
[2026-01-08 12:41:39.194] [sctp] [debug] SCTP association setup ascId[7]
[2026-01-08 12:41:39.194] [ngap] [debug] Sending NG Setup Request
[2026-01-08 12:41:39.207] [ngap] [debug] NG Setup Response received
[2026-01-08 12:41:39.207] [ngap] [info] NG Setup procedure is successful
[2026-01-08 12:41:41.104] [rrc] [debug] UE[1] new signal detected
[2026-01-08 12:48:31.447] [rrc] [debug] UE[2] new signal detected
[2026-01-08 12:49:04.047] [rls] [debug] UE[1] signal lost

[2026-01-08 13:04:10.707] [rrc] [info] RRC Setup for UE[2]
[2026-01-08 13:04:10.708] [ngap] [debug] Initial NAS message received from UE[2]
[2026-01-08 13:04:10.721] [ngap] [debug] Initial Context Setup Request received


##########################################################
k·ªãch b·∫£n handover d·∫°ng ‚Äúmobility emulation‚Äù (mec1 ‚Üí mec2)
##########################################################
A) Chu·∫©n b·ªã: l·∫•y t√™n c√°c pod
NS=open5gs
UE_DEP=ueransim-ue1
GNB1_DEP=ueransim-gnb-mec1
GNB2_DEP=ueransim-gnb-mec2

UEPOD=$(kubectl -n $NS get pod -l app=ueransim,component=ue,name=ue1 -o jsonpath='{.items[0].metadata.name}')
GNB1POD=$(kubectl -n $NS get pod -l app=ueransim,component=gnb,site=mec1 -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
GNB2POD=$(kubectl -n $NS get pod -l app=ueransim,component=gnb,site=mec2 -o jsonpath='{.items[0].metadata.name}')
AMF_POD=$(kubectl -n $NS get pod -l nf=amf -o jsonpath='{.items[0].metadata.name}')

echo "UEPOD=$UEPOD"
echo "GNB1POD=$GNB1POD"
echo "GNB2POD=$GNB2POD"
echo "AMF_POD=$AMF_POD"

B) Phase 1 ‚Äî ‚ÄúUE ·ªü MEC1‚Äù
1) B·∫≠t mec1, t·∫Øt mec2 (ƒë·ªÉ UE ch·∫Øc ch·∫Øn ch·ªçn TAC=1)
kubectl -n $NS scale deploy/$GNB1_DEP --replicas=1
kubectl -n $NS scale deploy/$GNB2_DEP --replicas=0

kubectl -n $NS rollout status deploy/$GNB1_DEP --timeout=120s
kubectl -n $NS rollout restart deploy/$UE_DEP
kubectl -n $NS rollout status deploy/$UE_DEP --timeout=180s

2) Ch·ª•p log UE ƒë·ªÉ th·∫•y tac[1]
kubectl -n $NS logs deploy/$UE_DEP -c ue --since=3m --tail=200 | egrep -i 'Selected cell|tac\[|Registration|PDU Session|establishment|successful|RRC|Signal' || true

C) Phase 2 ‚Äî ‚ÄúUE di chuy·ªÉn sang MEC2‚Äù
3) ‚ÄúDi chuy·ªÉn‚Äù: t·∫Øt mec1, b·∫≠t mec2
kubectl -n $NS scale deploy/$GNB1_DEP --replicas=0
kubectl -n $NS scale deploy/$GNB2_DEP --replicas=1

kubectl -n $NS rollout status deploy/$GNB2_DEP --timeout=120s

4) Restart UE ƒë·ªÉ n√≥ reselect cell s·∫°ch (ƒë·ª° ph·ª• thu·ªôc state c≈©)
kubectl -n $NS rollout restart deploy/$UE_DEP
kubectl -n $NS rollout status deploy/$UE_DEP --timeout=180s

5) Ch·ª•p log UE ƒë·ªÉ th·∫•y tac[2]
kubectl -n $NS logs deploy/$UE_DEP -c ue --since=3m --tail=250 | egrep -i 'Selected cell|tac\[|Signal lost|New signal|Registration|PDU Session|establishment|successful' || true


üëâ N·∫øu ƒë√∫ng, b·∫°n s·∫Ω th·∫•y d√≤ng ki·ªÉu:

Selected cell ... tac[2] ...

D) B·∫±ng ch·ª©ng ‚ÄúUE chuy·ªÉn gNB‚Äù (ƒë∆∞a v√†o lu·∫≠n vƒÉn)
6) Log gNB2 c√≥ ‚ÄúInitial NAS message‚Ä¶‚Äù sau khi UE chuy·ªÉn
kubectl -n $NS logs deploy/$GNB2_DEP -c gnb --since=5m --tail=250 | egrep -i 'UE\[|Initial NAS|RRC Setup|Context|PDU|registration|setup|ngap' || true

7) AMF log x√°c nh·∫≠n UE attach l·∫°i (l·ªçc theo IMSI)
kubectl -n $NS logs "$AMF_POD" --since=10m --tail=500 | egrep -i 'imsi-001010000000001|tac|tai|registration|dereg|guti|pdu|smf|ngap|ue' || true

E) Check nhanh: user-plane v·∫´n OK sau khi ‚Äúchuy·ªÉn‚Äù
UEPOD=$(kubectl -n $NS get pod -l app=ueransim,component=ue,name=ue1 -o jsonpath='{.items[0].metadata.name}')
kubectl -n $NS exec -it "$UEPOD" -c ue -- sh -lc 'ip -br a; ping -c 3 8.8.8.8 || true'


####################################################################
Output cho k·ªãch b·∫£n handover d·∫°ng ‚Äúmobility emulation‚Äù (mec1 ‚Üí mec2)
####################################################################
root@MasterK8s:~/open5gs-k8s# NS=open5gs
UE_DEP=ueransim-ue1
GNB1_DEP=ueransim-gnb-mec1
GNB2_DEP=ueransim-gnb-mec2

UEPOD=$(kubectl -n $NS get pod -l app=ueransim,component=ue,name=ue1 -o jsonpath='{.items[0].metadata.name}')
GNB1POD=$(kubectl -n $NS get pod -l app=ueransim,component=gnb,site=mec1 -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
GNB2POD=$(kubectl -n $NS get pod -l app=ueransim,component=gnb,site=mec2 -o jsonpath='{.items[0].metadata.name}')
AMF_POD=$(kubectl -n $NS get pod -l nf=amf -o jsonpath='{.items[0].metadata.name}')

echo "UEPOD=$UEPOD"
echo "GNB1POD=$GNB1POD"
echo "GNB2POD=$GNB2POD"
echo "AMF_POD=$AMF_POD"
UEPOD=ueransim-ue1-6868f8c8f8-2s8dm
GNB1POD=
GNB2POD=ueransim-gnb-mec2-57f6776545-6mdb9
AMF_POD=open5gs-amf-6c8754854-p67d6
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS scale deploy/$GNB1_DEP --replicas=1
kubectl -n $NS scale deploy/$GNB2_DEP --replicas=0

kubectl -n $NS rollout status deploy/$GNB1_DEP --timeout=120s
kubectl -n $NS rollout restart deploy/$UE_DEP
kubectl -n $NS rollout status deploy/$UE_DEP --timeout=180s
deployment.apps/ueransim-gnb-mec1 scaled
deployment.apps/ueransim-gnb-mec2 scaled
Waiting for deployment "ueransim-gnb-mec1" rollout to finish: 0 of 1 updated replicas are available...
deployment "ueransim-gnb-mec1" successfully rolled out
deployment.apps/ueransim-ue1 restarted
Waiting for deployment "ueransim-ue1" rollout to finish: 0 out of 1 new replicas have been updated...
Waiting for deployment "ueransim-ue1" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "ueransim-ue1" rollout to finish: 1 old replicas are pending termination...
deployment "ueransim-ue1" successfully rolled out
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS logs deploy/$UE_DEP -c ue --since=3m --tail=200 | egrep -i 'Selected cell|tac\[|Registration|PDU Session|establishment|successful|RRC|Signal' || true
[2026-01-05 15:45:02.140] [rrc] [debug] New signal detected for cell[1], total [1] cells in coverage
[2026-01-05 15:45:02.140] [rrc] [debug] New signal detected for cell[2], total [2] cells in coverage
[2026-01-05 15:45:02.143] [rrc] [info] Selected cell plmn[001/01] tac[1] category[SUITABLE]
[2026-01-05 15:45:02.144] [nas] [debug] Initial registration required due to [MM-DEREG-NORMAL-SERVICE]
[2026-01-05 15:45:02.147] [nas] [debug] Sending Initial Registration
[2026-01-05 15:45:02.148] [rrc] [debug] Sending RRC Setup Request
[2026-01-05 15:45:02.153] [rrc] [info] RRC connection established
[2026-01-05 15:45:02.153] [rrc] [info] UE switches to state [RRC-CONNECTED]
[2026-01-05 15:45:02.303] [nas] [debug] Registration accept received
[2026-01-05 15:45:02.303] [nas] [debug] Sending Registration Complete
[2026-01-05 15:45:02.303] [nas] [info] Initial Registration is successful
[2026-01-05 15:45:02.303] [nas] [debug] Sending PDU Session Establishment Request
[2026-01-05 15:45:02.730] [nas] [debug] PDU Session Establishment Accept received
[2026-01-05 15:45:02.730] [nas] [info] PDU Session establishment is successful PSI[1]
[2026-01-05 15:45:02.797] [app] [info] Connection setup for PDU session[1] is successful, TUN interface[uesimtun0, 10.41.0.4] is up.
[2026-01-05 15:45:19.749] [rrc] [debug] Signal lost for cell[2], total [1] cells in coverage
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS scale deploy/$GNB1_DEP --replicas=0
kubectl -n $NS scale deploy/$GNB2_DEP --replicas=1

kubectl -n $NS rollout status deploy/$GNB2_DEP --timeout=120s
deployment.apps/ueransim-gnb-mec1 scaled
deployment.apps/ueransim-gnb-mec2 scaled
Waiting for deployment "ueransim-gnb-mec2" rollout to finish: 0 out of 1 new replicas have been updated...
Waiting for deployment "ueransim-gnb-mec2" rollout to finish: 0 of 1 updated replicas are available...
deployment "ueransim-gnb-mec2" successfully rolled out
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS rollout restart deploy/$UE_DEP
kubectl -n $NS rollout status deploy/$UE_DEP --timeout=180s
deployment.apps/ueransim-ue1 restarted
Waiting for deployment "ueransim-ue1" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "ueransim-ue1" rollout to finish: 1 old replicas are pending termination...
deployment "ueransim-ue1" successfully rolled out
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS logs deploy/$UE_DEP -c ue --since=3m --tail=250 | egrep -i 'Selected cell|tac\[|Signal lost|New signal|Registration|PDU Session|establishment|successful' || true
Found 2 pods, using pod/ueransim-ue1-65bc95c8b-cc8rr
[2026-01-05 15:48:16.370] [rrc] [debug] New signal detected for cell[3], total [2] cells in coverage
[2026-01-05 15:48:42.185] [rrc] [debug] Signal lost for cell[1], total [1] cells in coverage
[2026-01-05 15:48:42.226] [rrc] [info] Selected cell plmn[001/01] tac[2] category[SUITABLE]
root@MasterK8s:~/open5gs-k8s#
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS logs deploy/$GNB2_DEP -c gnb --since=5m --tail=250 | egrep -i 'UE\[|Initial NAS|RRC Setup|Context|PDU|registration|setup|ngap' || true
[2026-01-05 15:48:14.957] [sctp] [debug] SCTP association setup ascId[6]
[2026-01-05 15:48:14.957] [ngap] [debug] Sending NG Setup Request
[2026-01-05 15:48:14.974] [ngap] [debug] NG Setup Response received
[2026-01-05 15:48:14.974] [ngap] [info] NG Setup procedure is successful
[2026-01-05 15:48:16.364] [rrc] [debug] UE[1] new signal detected
[2026-01-05 15:48:42.716] [rrc] [debug] UE[2] new signal detected
[2026-01-05 15:48:42.724] [rrc] [info] RRC Setup for UE[2]
[2026-01-05 15:48:42.726] [ngap] [debug] Initial NAS message received from UE[2]
[2026-01-05 15:48:42.863] [ngap] [debug] Initial Context Setup Request received
[2026-01-05 15:48:43.188] [ngap] [info] PDU session resource(s) setup for UE[2] count[1]
[2026-01-05 15:49:14.996] [rls] [debug] UE[1] signal lost
root@MasterK8s:~/open5gs-k8s# kubectl -n $NS logs "$AMF_POD" --since=10m --tail=500 | egrep -i 'imsi-001010000000001|tac|tai|registration|dereg|guti|pdu|smf|ngap|ue' || true
Defaulted container "amf" out of: amf, wait-scp (init)
01/05 15:44:51.111: [amf] INFO: gNB-N2 accepted[10.10.3.231]:43973 in ng-path module (../src/amf/ngap-sctp.c:113)
01/05 15:44:54.485: [amf] INFO: InitialUEMessage (../src/amf/ngap-handler.c:401)
01/05 15:44:54.485: [amf] INFO: [Added] Number of gNB-UEs is now 1 (../src/amf/context.c:2550)
01/05 15:44:54.486: [amf] INFO: Unknown UE by 5G-S_TMSI[AMF_ID:0x20040,M_TMSI:0xb3] (../src/amf/ngap-handler.c:479)
01/05 15:44:54.486: [amf] INFO:     RAN_UE_NGAP_ID[1] AMF_UE_NGAP_ID[1] TAC[1] CellID[0x10] (../src/amf/ngap-handler.c:562)
01/05 15:44:54.491: [amf] INFO: Unknown UE by 5G-S_TMSI[AMF_ID:0x20040,M_TMSI:0xc00000b3] (../src/amf/context.c:1853)
01/05 15:44:54.491: [amf] INFO: [Added] Number of AMF-UEs is now 1 (../src/amf/context.c:1616)
01/05 15:44:54.491: [gmm] INFO: Registration request (../src/amf/gmm-sm.c:1165)
01/05 15:44:54.491: [gmm] INFO: [Unknown ID]    5G-S_GUTI[AMF_ID:0x20040,M_TMSI:0xc00000b3] (../src/amf/gmm-handler.c:179)
01/05 15:44:54.848: [gmm] INFO: [imsi-001010000000001] Registration complete (../src/amf/gmm-sm.c:2146)
01/05 15:44:54.848: [amf] INFO: [imsi-001010000000001] Configuration update command (../src/amf/nas-path.c:612)
01/05 15:45:02.158: [amf] INFO: InitialUEMessage (../src/amf/ngap-handler.c:401)
01/05 15:45:02.158: [amf] INFO: [Added] Number of gNB-UEs is now 2 (../src/amf/context.c:2550)
01/05 15:45:02.158: [amf] INFO:     RAN_UE_NGAP_ID[2] AMF_UE_NGAP_ID[2] TAC[1] CellID[0x10] (../src/amf/ngap-handler.c:562)
01/05 15:45:02.159: [amf] INFO: [suci-0-001-01-0000-0-0-0000000001] known UE by SUCI (../src/amf/context.c:1833)
01/05 15:45:02.159: [gmm] INFO: Registration request (../src/amf/gmm-sm.c:1165)
01/05 15:45:02.165: [amf] INFO: UE Context Release [Action:1] (../src/amf/ngap-handler.c:1698)
01/05 15:45:02.165: [amf] INFO:     RAN_UE_NGAP_ID[1] AMF_UE_NGAP_ID[1] (../src/amf/ngap-handler.c:1699)
01/05 15:45:02.165: [amf] INFO: [Removed] Number of gNB-UEs is now 1 (../src/amf/context.c:2557)
01/05 15:45:02.502: [gmm] INFO: [imsi-001010000000001] Registration complete (../src/amf/gmm-sm.c:2146)
01/05 15:45:02.517: [amf] INFO: [imsi-001010000000001] Configuration update command (../src/amf/nas-path.c:612)
01/05 15:45:02.526: [gmm] INFO: UE SUPI[imsi-001010000000001] DNN[internet] S_NSSAI[SST:1 SD:0x1] smContextRef [NULL] (../src/amf/gmm-handler.c:1241)
01/05 15:45:02.526: [gmm] INFO: No SMF Instance (../src/amf/gmm-handler.c:1278)
01/05 15:45:02.624: [sbi] INFO: [SMF] (SCP-discover) NF registered [36cbba9e-e97d-41f0-aa8f-4b47a2a067fb:1] (../lib/sbi/path.c:211)
01/05 15:45:02.776: [amf] INFO: [imsi-001010000000001:1:11][0:0:NULL] /nsmf-pdusession/v1/sm-contexts/{smContextRef}/modify (../src/amf/nsmf-handler.c:837)
01/05 15:48:14.933: [amf] INFO: gNB-N2 accepted[10.10.3.232]:53538 in ng-path module (../src/amf/ngap-sctp.c:113)
01/05 15:48:40.717: [amf] INFO: [Removed] Number of gNB-UEs is now 0 (../src/amf/context.c:2557)
01/05 15:48:40.717: [amf] INFO: [imsi-001010000000001:1:51][0:0:NULL] /nsmf-pdusession/v1/sm-contexts/{smContextRef}/modify (../src/amf/nsmf-handler.c:837)
01/05 15:48:42.704: [amf] INFO: InitialUEMessage (../src/amf/ngap-handler.c:401)
01/05 15:48:42.704: [amf] INFO: [Added] Number of gNB-UEs is now 1 (../src/amf/context.c:2550)
01/05 15:48:42.704: [amf] INFO:     RAN_UE_NGAP_ID[1] AMF_UE_NGAP_ID[3] TAC[2] CellID[0x11] (../src/amf/ngap-handler.c:562)
01/05 15:48:42.705: [amf] INFO: [suci-0-001-01-0000-0-0-0000000001] known UE by SUCI (../src/amf/context.c:1833)
01/05 15:48:42.705: [gmm] INFO: Registration request (../src/amf/gmm-sm.c:1165)
01/05 15:48:42.756: [amf] INFO: [imsi-001010000000001:1] Release SM context [204] (../src/amf/amf-sm.c:491)
01/05 15:48:42.756: [amf] INFO: [imsi-001010000000001:1] Release SM Context [state:31] (../src/amf/nsmf-handler.c:1027)
01/05 15:48:43.044: [gmm] INFO: [imsi-001010000000001] Registration complete (../src/amf/gmm-sm.c:2146)
01/05 15:48:43.044: [amf] INFO: [imsi-001010000000001] Configuration update command (../src/amf/nas-path.c:612)
01/05 15:48:43.045: [gmm] INFO: UE SUPI[imsi-001010000000001] DNN[internet] S_NSSAI[SST:1 SD:0x1] smContextRef [NULL] (../src/amf/gmm-handler.c:1241)
01/05 15:48:43.045: [gmm] INFO: No SMF Instance (../src/amf/gmm-handler.c:1278)
01/05 15:48:43.124: [sbi] WARNING: [SMF] (SCP-discover) NF has already been added [36cbba9e-e97d-41f0-aa8f-4b47a2a067fb:1] (../lib/sbi/path.c:216)
01/05 15:48:43.198: [amf] INFO: [imsi-001010000000001:1:11][0:0:NULL] /nsmf-pdusession/v1/sm-contexts/{smContextRef}/modify (../src/amf/nsmf-handler.c:837)
root@MasterK8s:~/open5gs-k8s#
root@MasterK8s:~/open5gs-k8s# UEPOD=$(kubectl -n $NS get pod -l app=ueransim,component=ue,name=ue1 -o jsonpath='{.items[0].metadata.name}')
kubectl -n $NS exec -it "$UEPOD" -c ue -- sh -lc 'ip -br a; ping -c 3 8.8.8.8 || true'
lo               UNKNOWN        127.0.0.1/8 ::1/128
tunl0@NONE       DOWN
eth0@if17        UP             192.168.131.203/32 fe80::98ac:9dff:fe54:569a/64
uesimtun0        UNKNOWN        10.41.0.5/32 fe80::7ba:c7b2:9cdf:298a/64
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=114 time=19.5 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=114 time=19.3 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=114 time=19.3 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2001ms
rtt min/avg/max/mdev = 19.277/19.368/19.533/0.116 ms
root@MasterK8s:~/open5gs-k8s#


1) B·∫±ng ch·ª©ng UE ƒë√£ ‚Äúdi chuy·ªÉn‚Äù gNB1 ‚Üí gNB2 (TAC1 ‚Üí TAC2)
B·∫°n c√≥ ƒë·ªß 2 m·ªëc log quan tr·ªçng:
·ªû MEC1:
Selected cell ... tac[1] ...
Registration + PDU session OK
uesimtun0 l√™n 10.41.0.4
Sau khi t·∫Øt gNB1 / b·∫≠t gNB2:
Signal lost for cell[1]...
Selected cell ... tac[2] category[SUITABLE]
uesimtun0 ƒë·ªïi sang 10.41.0.5
ping 8.8.8.8 OK
üëâ ƒê·ªïi TAC + ƒë·ªïi IP PDU (10.41.0.4 ‚Üí 10.41.0.5) l√† b·∫±ng ch·ª©ng c·ª±c m·∫°nh: UE ƒë√£ attach l·∫°i ·ªü v√πng kh√°c v√† SMF/UPF c·∫•p IP m·ªõi.

3) B∆∞·ªõc ti·∫øp theo ƒë·ªÉ ‚Äúch·ª©ng minh chuy·ªÉn gNB‚Äù trong lu·∫≠n vƒÉn (c·∫ßn th√™m 2 output)
Hi·ªán b·∫°n ƒë√£ c√≥ UE-side evidence. ƒê·ªÉ b√†i l√†m ‚Äúƒë·∫πp v√† ch·∫Øc‚Äù, th√™m 2 evidence ph√≠a core/gNB:
(A) gNB2 log c√≥ ‚ÄúInitial NAS / UE attach l·∫°i‚Äù
Ch·∫°y:
kubectl -n open5gs logs deploy/ueransim-gnb-mec2 -c gnb --since=10m --tail=250 | egrep -i 'UE\[|Initial NAS|RRC Setup|Registration|PDU|Context|tac|plmn' || true

(B) AMF log c√≥ TAI/TAC/Registration c·ªßa IMSI
Ch·∫°y:
AMF_POD=$(kubectl -n open5gs get pod -l nf=amf -o jsonpath='{.items[0].metadata.name}')
kubectl -n open5gs logs "$AMF_POD" --since=10m --tail=600 | egrep -i 'imsi-001010000000001|tac|tai|registration|dereg|gmm|smf|pdu|ngap' || true

G·ª≠i 2 output n√†y l√† m√¨nh s·∫Ω ch·ªâ ƒë√∫ng c√¢u n√†o ƒë·ªÉ tr√≠ch v√†o lu·∫≠n vƒÉn (v√≠ d·ª• ‚ÄúUE re-register in TAC=2‚Äù, ‚ÄúgNB2 receives Initial NAS‚Äù, ‚Ä¶).

4) Tr·∫£ l·ªùi nhanh: ‚Äúƒë√£ l√†m ƒë∆∞·ª£c migration ƒë·ªÅ t√†i 2 ch∆∞a?‚Äù
Ch∆∞a (m·ªõi ch·ª©ng minh UE mobility, ch∆∞a ch·ª©ng minh service migration).
Hi·ªán b·∫°n m·ªõi ƒë·∫°t:
‚úÖ UE chuy·ªÉn v√πng (TAC1 ‚Üí TAC2)
‚úÖ PDU session OK v√† user-plane ra Internet
ƒê·ªÉ th√†nh ‚Äúservice migration MEC‚Äù, b·∫°n c·∫ßn th√™m m·ªôt d·ªãch v·ª• edge ch·∫°y ·ªü MEC1/MEC2 + c∆° ch·∫ø ‚Äúdi chuy·ªÉn‚Äù ho·∫∑c ‚Äúƒë·ªïi ƒë√≠ch‚Äù theo v·ªã tr√≠ UE.

5) L√†m sao ch·ª©ng minh ‚Äúd·ªãch v·ª• c≈©ng di chuy·ªÉn theo‚Äù (ƒë·ªÅ t√†i 2) ‚Äî c√°ch ƒë∆°n gi·∫£n nh·∫•t
Kh√¥ng c·∫ßn Prometheus/Grafana v·∫´n l√†m ƒë∆∞·ª£c demo lu·∫≠n vƒÉn.
C√°ch d·ªÖ nh·∫•t (khuy·∫øn ngh·ªã): ‚Äú2 edge service + traffic steering‚Äù
Deploy edge-app-mec1 (nodeSelector mec1) v√† edge-app-mec2 (nodeSelector mec2)
V√≠ d·ª• HTTP server tr·∫£ v·ªÅ ch·ªØ: Hello from MEC1 / Hello from MEC2.
T·∫°o 1 service name chung (v√≠ d·ª• edge-service) nh∆∞ng selector thay ƒë·ªïi theo v·ªã tr√≠ UE (ho·∫∑c update EndpointSlice).
Khi UE ·ªü TAC1 ‚Üí route ƒë·∫øn MEC1. Khi UE sang TAC2 ‚Üí switch route sang MEC2.
Ch·ª©ng minh b·∫±ng:
curl t·ª´ UE: tr∆∞·ªõc tr·∫£ ‚ÄúMEC1‚Äù, sau tr·∫£ ‚ÄúMEC2‚Äù
ping v·∫´n OK, session v·∫´n OK
N·∫øu b·∫°n mu·ªën ‚Äúƒë√∫ng nghƒ©a migration‚Äù h∆°n:
d√πng live migration (VM/Container) ho·∫∑c state transfer (Redis/Postgres snapshot) gi·ªØa MEC1‚ÜîMEC2, nh∆∞ng ph·ª©c t·∫°p h∆°n.
